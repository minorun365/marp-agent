# 暫定修正: HTTP Requestツール制限 & スライドデザイン改善

## 課題1: HTTP Requestツールの過剰使用

### 現象

- http_requestツール導入後、コンテキスト量（トークン数）が増加しコスト上昇
- Tavily検索回数も増加し、APIキーの消費が激化
- 推測される原因: プロンプトの「web_search結果から詳細を確認したい場合はhttp_requestで取得」という指示により、
  エージェントがweb_search → 検索結果のURL全てにhttp_request → さらに情報不足と判断して再検索...のループに陥っている

### 修正方針

**config.py のシステムプロンプト「Web検索・Webページ取得」セクションを書き換え:**

```
## Web検索・Webページ取得
- 最新情報が必要な場合は web_search ツールで調べてから作成。不十分なら再検索
- http_request ツールは以下の場合のみ使用:
  1. ユーザーがURLを直接メッセージに貼った場合（そのURLの内容を取得）
  2. web_searchだけでは十分な情報が得られず、特定URLの詳細が必要な場合
- web_searchの結果だけでスライドが作れる場合は、http_requestを使わない
  （検索結果のcontent snippetで十分なケースがほとんど）
- エラー時（検索エラー・APIキー未設定・rate limit等）は...（既存の案内文）
```

**狙い:**
- 「Tavily APIクレジット節約のため」という http_request 推奨の文言を削除
- 「使ってよい場面」を明示列挙して、それ以外では使わせない
- web_searchのsnippetで足りることを明記して不要なURLアクセスを抑制


---

## 課題2: スライドが簡素すぎる / デザインが単調

### 現象

- 行数制限（9行）の導入後、全スライドで行数が半分程度しか使われていない
- 箇条書きベタ書き指示により「短い箇条書きが3〜5個だけ」のスライドが連続する
- 表・引用・図解表現などのバリエーションが減り、人間が作るスライドと比べて単調

### 原因分析

1. **行数制限の萎縮効果**: 9行制限を意識しすぎて、6〜7行まで使えるところを3〜4行で終わらせてしまう
2. **ベタ書き指示の副作用**: 「**見出し**: 説明」を禁止したことで、情報密度が下がり箇条書きが短文の羅列になりがち
3. **構成テクニックの指示不足**: 「多様な形式」とだけ書いてあるが、具体例や使い分けの指針がない

### 修正方針

**config.py のシステムプロンプト「スライド作成ルール」「構成テクニック」を改善:**

#### A. 行数ルールのニュアンス調整

現状:
```
- **1スライドの行数制限**: 見出し＋小見出し＋本文等すべて合わせて9行以内に収める
```

修正案:
```
- **1スライドの行数制限**: 見出し＋本文等すべて合わせて9行以内（output_slideが自動検証）。
  ただし余白が多すぎるのもNG。目安として6〜9行を使い、情報量と読みやすさのバランスを取る
```

#### B. 構成テクニックの具体化

現状:
```
- **多様な形式**: 表、引用ブロック（`>`）を使い分け、箇条書きの単調な連続を避ける
- **箇条書きスタイル**: 「**見出し**: 説明」形式は使わず、説明内容だけをベタ書きで書く（太字不使用）
```

修正案:
```
- **多様な表現パターン**（以下を組み合わせて箇条書きだけのスライドが3枚以上連続しないようにする）:
  - 箇条書き: 3〜5項目のリスト。1項目1〜2行で簡潔に
  - 表（テーブル）: 比較・一覧には積極的に使う（2〜4列 × 3〜6行が目安）
  - 引用ブロック（`>`）: 重要なメッセージや定義の強調に
  - 「見出し + 説明文」: 箇条書きではなく、小見出し（`###`）と本文の組み合わせ
  - 数値・ファクトの強調: 「**3つ**のポイント」のように数値を見出しに使う
- **箇条書きスタイル**: 箇条書きでは「**キーワード**: 説明」形式は避け、内容をそのまま書く
- **情報密度**: スライド下半分が空白にならないよう、各ページの余白を活用する。
  例: 箇条書き3項目だけで終わらず、補足説明や具体例を追加して5〜7行にする
```

#### C. 全体構成のガイドライン追加

```
## スライド全体の構成
- 目安枚数: 8〜15枚（タイトル・裏表紙含む）
- 冒頭2〜3枚で背景・課題を提示、中盤で解決策・詳細、終盤でまとめ
- 「箇条書きだけのスライド」が3枚以上連続したら、表・引用・図解テキストなど別の表現を挟む
```

---

## 修正対象ファイル

| ファイル | 修正内容 |
|---------|---------|
| `amplify/agent/runtime/config.py` | システムプロンプトの書き換え（課題1 + 課題2） |

※ コード側（output_slide.py, http_request.py）の変更は不要。プロンプト修正のみで対応。

## 効果測定

- セッション単価（$/回）の変化を `/check-app-stats` で追跡
- Tavily日次消費クレジットの変化を確認
- スライドの見た目・バリエーションは実際に生成して目視確認
