# 参考資料アップロード機能 実装計画

> **対応issue**: #22
> **工数見積もり**: 5-7日（Phase 1: 3日 / Phase 2: 2-4日）
> **作成日**: 2026-02-19

## 概要

チャット入力欄にファイル添付ボタンを追加し、参考資料（PDF）をアップロードしてスライド生成の参考にできるようにする。

## アーキテクチャ

```
[ブラウザ]
    │
    ├─ ChatInput（📎ボタン追加）
    │    ├─ ファイル選択 → バリデーション → プレビュー表示
    │    └─ 送信時: テキスト + PDF(Base64) を JSON ボディに含めて POST
    │
[agentCoreClient]
    │
    └─> POST /runtimes/{arn}/invocations
         Body: { prompt, markdown, model_type, theme, reference_file }
                ↓
[AgentCore Runtime（Python）]
    │
    ├─> Base64 デコード → /tmp に保存（エフェメラル）
    ├─> pdfplumber でテキスト抽出
    ├─> 抽出テキストをプロンプトに付加
    └─> 通常のスライド生成フローへ
```

## Phase 1: MVP（3日）

PDF テキスト抽出のみ。画像パース・OCR なし。

### 1-1. フロントエンド

#### ChatInput に添付ボタン追加

- テキスト入力欄の左側（モデルセレクターの右隣）に 📎 クリップアイコンのボタンを配置
- クリックで `<input type="file" accept=".pdf">` を起動
- ファイル選択後、入力欄の上部に選択ファイル名 + ✕ ボタンのチップを表示
- 送信ボタン押下でテキストと一緒にファイルデータを送信

#### ファイルバリデーション（フロントエンド側）

| チェック項目 | 制限値 | エラーメッセージ |
|-------------|--------|-----------------|
| ファイル形式 | `.pdf` のみ | 「PDF ファイルのみアップロードできます」 |
| ファイルサイズ | **10MB** | 「ファイルサイズは10MB以下にしてください」 |
| ファイル数 | 1ファイル | （UIで1ファイルのみ選択可能にする） |

#### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/components/Chat/ChatInput.tsx` | 📎ボタン、ファイル選択、チップ表示 |
| `src/components/Chat/types.ts` | `ReferenceFile` 型定義追加 |
| `src/components/Chat/index.tsx` | ファイル state 管理、送信時のファイル連携 |
| `src/components/Chat/hooks/useChatMessages.ts` | `invokeAgent` 呼び出し時にファイルデータを渡す |
| `src/hooks/api/agentCoreClient.ts` | リクエストボディに `reference_file` フィールド追加 |

### 1-2. バックエンド

#### PDF テキスト抽出処理

- `agent.py` のエントリポイントで `reference_file` を受け取り
- Base64 デコード → `/tmp/{ファイル名}` に保存
- `pdfplumber` でテキスト抽出
- 抽出テキストをプロンプトの前に付加してエージェントに渡す

#### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `amplify/agent/runtime/agent.py` | PDF 受信・テキスト抽出・プロンプト付加 |
| `amplify/agent/runtime/requirements.txt` | `pdfplumber` 追加 |
| `amplify/agent/runtime/pyproject.toml` | `pdfplumber` 追加 |

### 1-3. データフロー詳細

#### リクエストペイロード

```typescript
// フロントエンド → AgentCore
{
  prompt: "この資料をもとに5ページのスライドを作って",
  markdown: "",
  model_type: "sonnet",
  theme: "border",
  reference_file: {               // 新規フィールド（オプション）
    file_name: "proposal.pdf",
    content_type: "application/pdf",
    base64_data: "JVBERi0xLjQK...",
    size: 1234567
  }
}
```

#### バックエンド処理（agent.py）

```python
reference_file = payload.get("reference_file")
if reference_file:
    # バリデーション
    if reference_file["size"] > 10 * 1024 * 1024:
        yield {"type": "error", "error": "ファイルサイズが10MBを超えています"}
        return

    # Base64 デコード → /tmp に保存
    pdf_bytes = base64.b64decode(reference_file["base64_data"])
    pdf_path = f"/tmp/{reference_file['file_name']}"
    with open(pdf_path, "wb") as f:
        f.write(pdf_bytes)

    # テキスト抽出
    yield {"type": "status", "data": "参考資料を読み込んでいます..."}
    extracted_text = extract_text_from_pdf(pdf_path)

    # プロンプトに付加
    prompt = f"""以下は参考資料の内容です：

---参考資料ここから---
{extracted_text}
---参考資料ここまで---

上記の参考資料を踏まえて、{original_prompt}"""
```

---

## Phase 2: 拡張（2-4日）

Phase 1 完了後に検討する追加機能。

| 機能 | 概要 | 工数 |
|------|------|------|
| 画像付きPDF対応 | Bedrock Multimodal で画像内テキストも抽出 | 1-2日 |
| Word (.docx) 対応 | `python-docx` でテキスト抽出 | 0.5日 |
| テキストファイル対応 | `.txt`, `.md` をそのまま読み込み | 0.5日 |
| 複数ファイル対応 | 複数ファイルの同時アップロード | 1日 |

---

## 設計判断と確認事項

### 確認事項（みのるんへ）

#### 1. PDF送信方式: Base64 vs マルチパート

| 方式 | メリット | デメリット |
|------|---------|---------|
| **Base64 in JSON（推奨）** | 既存の SSE リクエスト構造をそのまま流用、実装がシンプル | サイズが約33%増（10MB PDF → 約13.3MB のペイロード） |
| マルチパートフォームデータ | サイズ効率が良い | AgentCore のエンドポイント仕様変更が必要か要調査、実装が複雑化 |

→ **Base64 方式を推奨**。10MB 制限なら Base64 化後も約13MB で、AgentCore Runtime（コンテナベース）なら問題ないはず。

#### 2. テキスト抽出のタイミング

| 方式 | メリット | デメリット |
|------|---------|---------|
| **バックエンド抽出（推奨）** | フロントに追加ライブラリ不要、サーバー側で品質管理可能 | バックエンドのペイロードが大きくなる |
| フロントエンド抽出（pdf.js） | 送信データが軽量（テキストのみ） | フロントのバンドルサイズ増加（pdf.js は約700KB）、ブラウザ間差異 |

→ **バックエンド抽出を推奨**。pdfplumber は高品質なテキスト抽出ができ、将来的な画像パース拡張もしやすい。

#### 3. 抽出テキストの扱い方

| 方式 | メリット | デメリット |
|------|---------|---------|
| **プロンプト付加（推奨）** | 実装がシンプル、エージェントが自然に参照可能 | プロンプトが長くなる（トークンコスト増） |
| 専用ツール化 | エージェントが必要に応じて参照、トークン節約 | エージェントがツールを呼ばない可能性、実装が複雑 |

→ **プロンプト付加を推奨**。参考資料はユーザーが「これを見てスライド作って」と指示するものなので、必ず参照すべき。ツール化するとエージェントが読み飛ばすリスクがある。

#### 4. ファイルサイズ上限

- **10MB を推奨**。一般的な提案資料PDFは数MB程度
- pdfplumber のテキスト抽出は高速で、10MB の PDF でも数秒以内
- 抽出テキストが長すぎる場合は、先頭 N 文字（例: 50,000文字 ≒ 約25,000トークン）で切る安全策を入れる

> **確認**: 10MB で問題ないですか？もう少し小さく（5MB）にしたほうがいいですか？

#### 5. UIの配置

現在の ChatInput レイアウト:
```
┌─────────────────────────────────────────┐
│ [モデル▼] [入力テキスト...            ] [→] │
└─────────────────────────────────────────┘
```

提案レイアウト:
```
                  ┌ ファイル選択時のみ表示
                  ↓
         ┌────────────────────────┐
         │ 📄 proposal.pdf (2.3MB) ✕ │
         └────────────────────────┘
┌─────────────────────────────────────────┐
│ [モデル▼] [📎] [入力テキスト...       ] [→] │
└─────────────────────────────────────────┘
              ↑
              クリップボタン（さりげない灰色アイコン）
```

> **確認**: この配置でイメージ合ってますか？📎 ボタンの位置を入力欄の中（右端、送信ボタンの隣）にする案もあります。

---

## エラーハンドリング

| エラーケース | 対処 | ユーザーへの表示 |
|-------------|------|-----------------|
| 非PDF形式を選択 | フロントでブロック（accept属性 + JS検証） | 「PDFファイルのみアップロードできます」 |
| 10MB超過 | フロントでブロック | 「ファイルサイズは10MB以下にしてください」 |
| PDF読み取り失敗 | バックエンドでキャッチ | 「PDFの読み取りに失敗しました。ファイルが破損していないか確認してください」 |
| テキスト抽出ゼロ | バックエンドで検出 | 「このPDFからテキストを抽出できませんでした（画像ベースのPDFの可能性があります）」 |
| パスワード保護PDF | バックエンドでキャッチ | 「パスワード保護されたPDFは対応していません」 |
| ペイロードサイズ超過 | バックエンド or AgentCore でリジェクト | 「ファイルが大きすぎます。より小さいファイルをお試しください」 |

---

## 依存ライブラリの追加

### Python（バックエンド）

```
pdfplumber>=0.11.0
```

- `pdfplumber` を選択した理由: テーブル・レイアウト認識が優秀で、提案資料に多い表やカラムのテキスト抽出品質が高い
- `PyPDF2` / `pypdf` でも可能だが、テキスト抽出品質は pdfplumber が上

### フロントエンド

追加ライブラリなし（標準の File API のみ使用）。

---

## テスト計画

### フロントエンド

- [ ] 📎ボタンクリックでファイル選択ダイアログが開く
- [ ] PDF 以外のファイルが選択できない
- [ ] 10MB 超のファイルでエラー表示
- [ ] ファイル選択後にチップが表示される
- [ ] チップの✕ボタンでファイルが解除される
- [ ] ファイル付きメッセージが正しく送信される
- [ ] ファイルなしの通常メッセージが従来通り動作する

### バックエンド

- [ ] PDF テキスト抽出が正しく動作する
- [ ] 抽出テキストがプロンプトに付加される
- [ ] 破損PDFでエラーが返る
- [ ] パスワード保護PDFでエラーが返る
- [ ] テキスト抽出ゼロのPDF（画像のみ）で警告が出る
- [ ] reference_file なしのリクエストが従来通り動作する

### E2E

- [ ] PDF アップロード → スライド生成の一連フロー
- [ ] モバイル端末でのファイル選択動作
